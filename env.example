# P1Lending ETL System - Environment Configuration
# ================================================
# SECURITY: All credentials marked as REQUIRED have no defaults.
# The application will FAIL TO START if these are not set.
#
# Generate SECRET_KEY with: python -c "import secrets; print(secrets.token_urlsafe(32))"

# ============================================================
# REQUIRED CREDENTIALS (NO DEFAULTS - MUST BE SET)
# ============================================================

# JWT Secret Key - REQUIRED
# Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
SECRET_KEY=

# PostgreSQL Database - REQUIRED
POSTGRES_USER=p1lending
POSTGRES_PASSWORD=
POSTGRES_DB=p1lending_etl

# Snowflake Credentials - REQUIRED
SNOWFLAKE_ACCOUNT=
SNOWFLAKE_USER=
SNOWFLAKE_PRIVATE_KEY_PASSWORD=

# CCC Litigator API - REQUIRED
CCC_API_KEY=

# idiCORE API - REQUIRED
IDICORE_CLIENT_ID=
IDICORE_CLIENT_SECRET=

# ============================================================
# SECURITY SETTINGS (IMPORTANT DEFAULTS)
# ============================================================

# Snowflake Security - MUST be false in production!
SNOWFLAKE_INSECURE_MODE=false
SNOWFLAKE_OCSP_FAIL_OPEN=false

# ============================================================
# OPTIONAL SETTINGS (SAFE DEFAULTS PROVIDED)
# ============================================================

# Database URL (for local development)
DATABASE_URL=postgresql+asyncpg://p1lending:${POSTGRES_PASSWORD}@postgres:5432/p1lending_etl

# Redis URL
REDIS_URL=redis://redis:6379/0

# CORS Origins (JSON array)
CORS_ORIGINS=["https://staging.etl.p1lending.io","https://etl.p1lending.io"]

# Snowflake Optional Settings
SNOWFLAKE_ROLE=ACCOUNTADMIN
SNOWFLAKE_WAREHOUSE=COMPUTE_WH
SNOWFLAKE_DATABASE=BULK_PROPERTY_DATA__NATIONAL_PRIVATE_SHARE
SNOWFLAKE_SCHEMA=PUBLIC
SNOWFLAKE_PRIVATE_KEY_PATH=/app/secrets/rsa_key.p8

# JWT Token Expiration
ACCESS_TOKEN_EXPIRE_MINUTES=15
REFRESH_TOKEN_EXPIRE_DAYS=7

# ETL Settings
ETL_BATCH_SIZE=200
LOG_LEVEL=INFO

# NTFY Push Notifications (optional)
NTFY_ENABLED=true
NTFY_BASE_URL=http://ntfy:80
NTFY_TOPIC_AUTH=p1-auth
NTFY_TOPIC_JOBS=p1-jobs
NTFY_TOPIC_ERRORS=p1-errors
NTFY_TOPIC_SYSTEM=p1-system

# ============================================
# ETL Performance Optimization Settings
# ============================================

# Snowflake Pre-Filtering (Priority 1)
# Enables database-side filtering to reduce memory usage and improve performance
# Set to false to use legacy Python-side filtering (not recommended)
ETL_USE_DATABASE_FILTERING=true

# DNC Batch Query Optimization (Priority 2)
# Enables batched WHERE IN queries for DNC checks (6-10x faster)
# Set to false to use legacy sequential queries (not recommended)
DNC_USE_BATCHED_QUERY=true

# ============================================
# CCC API Threading & Rate Limiting
# ============================================

# Dynamic Threading Configuration
CCC_MIN_WORKERS=2              # Minimum threads for litigator checks
CCC_MAX_WORKERS=16             # Maximum threads (typically CPU cores * 1-2)
CCC_WORKERS_PER_BATCH=1.5      # Thread multiplier per batch (for I/O-bound operations)

# Retry & Rate Limiting Configuration
CCC_MAX_RETRIES=4              # Maximum retry attempts on failure
CCC_RETRY_BASE_DELAY=1.0       # Initial retry delay in seconds
CCC_RETRY_MAX_DELAY=30.0       # Maximum retry delay cap in seconds

# ============================================
# idiCORE API Threading & Rate Limiting
# ============================================

# Dynamic Threading Configuration
IDICORE_MIN_WORKERS=10         # Minimum threads for phone enrichment
IDICORE_MAX_WORKERS=200        # Maximum threads for parallel API calls
IDICORE_WORKERS_SCALING=1.0    # Thread scaling factor (1.0 = 1 thread per person)

# Retry & Rate Limiting Configuration
IDICORE_MAX_RETRIES=4          # Maximum retry attempts on failure
IDICORE_RETRY_BASE_DELAY=1.0   # Initial retry delay in seconds
IDICORE_RETRY_MAX_DELAY=30.0   # Maximum retry delay cap in seconds

# ============================================
# Performance Optimization Notes
# ============================================
#
# ETL Performance Improvements (v2.0):
# - Snowflake Pre-Filtering: 10-15x faster cache filtering
# - DNC Batch Queries: 6-10x faster DNC checks
# - Dynamic Threading: Adaptive worker counts based on workload
# - Circuit Breaker: Prevents cascading failures during API outages
# - Exponential Backoff: Intelligent retry with jitter
#
# Expected Overall Performance: 4-8x faster ETL processing
#
# For rollback to legacy behavior:
# - Set ETL_USE_DATABASE_FILTERING=false
# - Set DNC_USE_BATCHED_QUERY=false
# - Set CCC_MAX_WORKERS=8 and CCC_MIN_WORKERS=8
# - Set IDICORE_MAX_WORKERS=150 and IDICORE_MIN_WORKERS=150
#
# Recommended Production Settings:
# - Keep all optimizations enabled (default values)
# - Adjust MAX_WORKERS based on server CPU cores
# - Monitor circuit breaker events in logs
# - Review worker decision logs for optimization opportunities
#
